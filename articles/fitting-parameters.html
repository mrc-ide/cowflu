<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>1) Model Fitting with cowflu • cowflu</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="1) Model Fitting with cowflu">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cowflu</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/cowflu.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fitting-parameters.html">1) Model Fitting with cowflu</a></li>
    <li><a class="dropdown-item" href="../articles/plotting-model.html">3) Plotting model outputs</a></li>
    <li><a class="dropdown-item" href="../articles/simulating-model.html">2) Simulating the model with fit parameters</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/cowflu/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>1) Model Fitting with cowflu</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/cowflu/blob/main/vignettes/fitting-parameters.Rmd" class="external-link"><code>vignettes/fitting-parameters.Rmd</code></a></small>
      <div class="d-none name"><code>fitting-parameters.Rmd</code></div>
    </div>

    
    
<p>This vignette walks through using the cowflu package to fit the
metapopulation model specified in the associated publication “A
mathematical model of H5N1 influenza transmission in US dairy
cattle”.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrc-ide.github.io/cowflu">cowflu</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/dust2" class="external-link">dust2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrc-ide.github.io/monty" class="external-link">monty</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="setting-model-parameters">Setting model parameters<a class="anchor" aria-label="anchor" href="#setting-model-parameters"></a>
</h2>
<p>First, as with the toy example vignette, we set the model parameters.
This time specific to our model.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="fu">cowflu_inputs</span><span class="op">(</span></span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  beta <span class="op">=</span> <span class="fl">1.45</span>,</span>
<span>  gamma <span class="op">=</span> <span class="fl">1.4</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>  asc_rate <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  dispersion <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="fu">cowflu</span><span class="fu">:::</span><span class="fu">cowflu_fixed_inputs</span><span class="op">(</span></span>
<span>    n_herds_per_region <span class="op">=</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="va">usda_data</span><span class="op">$</span><span class="va">n_herds_per_region</span>,</span>
<span>    p_region_export <span class="op">=</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="va">movement</span><span class="op">$</span><span class="va">p_region_export</span>,</span>
<span>    p_cow_export <span class="op">=</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="va">movement</span><span class="op">$</span><span class="va">p_cow_export</span>,</span>
<span>    n_cows_per_herd <span class="op">=</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="va">usda_data</span><span class="op">$</span><span class="va">n_cows_per_herd</span>,</span>
<span>    movement_matrix <span class="op">=</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="va">movement</span><span class="op">$</span><span class="va">movement_matrix</span>,</span>
<span>    time_test <span class="op">=</span> <span class="fl">19</span>, <span class="co">#Day 136 - April 29th 2024</span></span>
<span>    start_herd <span class="op">=</span> <span class="fl">26940</span>, <span class="co">#26804 is where Texas starts. #26940 is a median-sized Texas herd.</span></span>
<span>    start_count <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    condition_on_export <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    likelihood_choice <span class="op">=</span> <span class="st">"survival"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><code>alpha</code>, <code>beta</code>, <code>gamma</code>, and
<code>sigma</code> are epidemiological parameters. <code>asc_rate</code>
is an ascertainment rate scaling parameter that we fit.</p>
<p><code>n_herds_per_region</code> is a vector listing the number of
herds in each region.</p>
<p><code>p_region_export</code> is a vector listing the probability
that, each day, a herd within the respective region will export cattle
to another herd. This does not yet inform where that herd will go, only
whether or not an export is going to happen.</p>
<p><code>p_cow_export</code> is a vector listing the probability that,
given a herd is exporting cattle, what is the probability that each cow
in that herd will be included in the export.</p>
<p><code>n_cows_per_herd</code> is a vector listing exactly how many
cows are initialised in each herd of the model.</p>
<p><code>movement_matrix</code> details the probability of which region
an exported herd will be sent to. Element <code>(i, j)</code> is the
probability that an export from region <code>i</code> will be sent to
region <code>j</code>. Thus, each row will sum to 1.</p>
<p><code>time_test</code> is the time point (in weeks) at which cattle
will start being tested for flu. At this point, when a herd is exported
from one region to another, a number of cows will be sampled from the
exported cows. If any of these sampled cows are in the Infected
compartment, the export is cancelled.</p>
<p>The above six movement variables are explained in detail in section
2.4 of the Supplementary Material of the associated paper.</p>
<p><code>start_herd</code> is the herd in which infected cows are seeded
into at model initialisation.</p>
<p><code>start_count</code> is the number of infected cows to be seeded
into herd <code>start_herd</code> at model initialisation.</p>
<p><code>likelihood_choice</code> sets which likelihood function we will
use. Our default choice, the main result presented in this paper, fits
to a “survival function” - a step function detailing the point in time
when the first outbreak is detected in a state. An alternate option is
“incidence”, as explored in SI section 3.2.1.</p>
</div>
<div class="section level2">
<h2 id="set-priors">Set Priors<a class="anchor" aria-label="anchor" href="#set-priors"></a>
</h2>
<p>Epidemiological model parameters are fit to data via a Bayesian
evidence synthesis approach. We first set our priors for these
parameters.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu">monty</span><span class="fu">::</span><span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_dsl.html" class="external-link">monty_dsl</a></span><span class="op">(</span><span class="op">{</span></span>
<span>   <span class="va">alpha</span> <span class="op">~</span> <span class="fu">Uniform</span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>   <span class="va">beta</span> <span class="op">~</span> <span class="fu">Uniform</span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0.05</span>, max <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>   <span class="va">gamma</span> <span class="op">~</span> <span class="fu">Uniform</span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0.05</span>, max <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> </span>
<span>   <span class="va">sigma</span> <span class="op">~</span> <span class="fu">Uniform</span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0.05</span>, max <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> </span>
<span>   <span class="va">asc_rate</span> <span class="op">~</span> <span class="fu">Beta</span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, b <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span> <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Pack the priors</span></span>
<span><span class="va">pars_fixed</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">20</span><span class="op">:</span><span class="fl">24</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">prior_packer</span> <span class="op">&lt;-</span> <span class="fu">monty</span><span class="fu">::</span><span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_packer.html" class="external-link">monty_packer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"gamma"</span>, <span class="st">"sigma"</span>, <span class="st">"asc_rate"</span><span class="op">)</span>, fixed <span class="op">=</span> <span class="va">pars_fixed</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## With this packer we can convert from a list of name-value pairs suitable for</span></span>
<span><span class="co">## initialising a dust2 system into a vector of parameters suitable for use with monty:</span></span>
<span><span class="va">prior_packer</span><span class="op">$</span><span class="fu">pack</span><span class="op">(</span><span class="va">pars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.05 1.45 1.40 1.50 0.80</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-data">Load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h2>
<p>We load the data we will be fitting too. This should match the
likelihood function chosen. In this case, the step function of “time of
first outbreak detection” per state.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_outbreaks</span> <span class="op">&lt;-</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="fu">process_data_outbreak</span><span class="op">(</span><span class="fu">cowflu</span><span class="fu">:::</span><span class="va">outbreaks_data</span><span class="op">$</span><span class="va">weekly_outbreaks_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_week</span> <span class="op">&lt;-</span> <span class="fu">dust2</span><span class="fu">::</span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_filter_data.html" class="external-link">dust_filter_data</a></span><span class="op">(</span><span class="va">data_outbreaks</span>, time <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-dust2-items">Prepare dust2 items<a class="anchor" aria-label="anchor" href="#prepare-dust2-items"></a>
</h2>
<p>We build the particle filter, likelihood, and posterior distribution
using dust2. We can save the trajectories of the particle fitting by
un-commenting the <code>save_trajectories</code> argument.</p>
<p>We define the number of particles in the filter here as 2 for
simplicity. For the main results presented, we used 320 particles.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Build a particle filter</span></span>
<span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu">dust2</span><span class="fu">::</span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_filter_create.html" class="external-link">dust_filter_create</a></span><span class="op">(</span><span class="fu">cowflu</span><span class="fu">:::</span><span class="fu">cows</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="co">#0 is "time_start"</span></span>
<span>                                    <span class="va">data_week</span>, n_particles <span class="op">=</span> <span class="fl">2</span>, n_threads <span class="op">=</span> <span class="fl">32</span>, dt <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Reducing 'n_threads' from requested 32 to 2, to match the total number of</span></span>
<span><span class="co">#&gt; particles</span></span>
<span></span>
<span><span class="co">## Build a likelihood</span></span>
<span><span class="va">likelihood</span> <span class="op">&lt;-</span> <span class="fu">dust2</span><span class="fu">::</span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_likelihood_monty.html" class="external-link">dust_likelihood_monty</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">prior_packer</span>,</span>
<span>                                           save_state <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>                                           <span class="co">#,save_trajectories = c("outbreak_region", "infected_herds_region", "probability_test_pass_region")</span></span>
<span>                                           <span class="op">)</span></span>
<span></span>
<span><span class="co">## We combine the prior and the likelihood to create a posterior:</span></span>
<span><span class="va">posterior</span> <span class="op">&lt;-</span> <span class="va">prior</span> <span class="op">+</span> <span class="va">likelihood</span></span></code></pre></div>
<p>We also set the variance-covariance matrix for each parameter to be
used when exploring parameter space in-chain. We use a diagonal matrix,
i.e. no covariance between parameters.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vcv_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0015</span>, <span class="co">#alpha</span></span>
<span>                     <span class="fl">0.06</span>,   <span class="co">#beta</span></span>
<span>                     <span class="fl">0.05</span>,   <span class="co">#gamma</span></span>
<span>                     <span class="fl">0.05</span>,   <span class="co">#sigma</span></span>
<span>                     <span class="fl">0.02</span><span class="op">)</span><span class="op">)</span>  <span class="co">#asc_rate</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="launch-fits">Launch fits<a class="anchor" aria-label="anchor" href="#launch-fits"></a>
</h2>
<p>We reset the weighting on particles on average every 200 steps, as
shown in the sampler setup.</p>
<p>For simplicity’s sake, this vignette runs 4 chains for 20 samples
each. Average run time of &lt; 2mins. For the full model analysis we ran
16 chains of 40,000 samples.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Build sampler</span></span>
<span><span class="va">sampler</span> <span class="op">&lt;-</span> <span class="fu">monty</span><span class="fu">::</span><span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_sampler_random_walk.html" class="external-link">monty_sampler_random_walk</a></span><span class="op">(</span><span class="va">vcv_matrix</span>, </span>
<span>                                              rerun_every <span class="op">=</span> <span class="fl">200</span>,</span>
<span>                                              rerun_random <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## Run the samples</span></span>
<span><span class="va">fitting_samples</span> <span class="op">&lt;-</span> <span class="fu">monty</span><span class="fu">::</span><span class="fu"><a href="https://mrc-ide.github.io/monty/reference/monty_sample.html" class="external-link">monty_sample</a></span><span class="op">(</span><span class="va">posterior</span>, <span class="va">sampler</span>, </span>
<span>                                       n_steps <span class="op">=</span> <span class="fl">20</span>, </span>
<span>                                       n_chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                       initial <span class="op">=</span> <span class="va">prior_packer</span><span class="op">$</span><span class="fu">pack</span><span class="op">(</span><span class="va">pars</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>The resulting <code>fitting_samples</code> item is a list of 5 items.
<code>fittings_samples$pars</code> is samples from the posterior
distribution, which we shall use in the following vignette titled
“Simulating the model with fit parameters”.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thomas Rawson, Rich FitzJohn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
