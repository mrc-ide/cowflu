<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2) Simulating the model with fit parameters • cowflu</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2) Simulating the model with fit parameters">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cowflu</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/cowflu.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fitting-parameters.html">1) Model Fitting with cowflu</a></li>
    <li><a class="dropdown-item" href="../articles/plotting-model.html">3) Plotting model outputs</a></li>
    <li><a class="dropdown-item" href="../articles/simulating-model.html">2) Simulating the model with fit parameters</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/cowflu/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>2) Simulating the model with fit parameters</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/cowflu/blob/main/vignettes/simulating-model.Rmd" class="external-link"><code>vignettes/simulating-model.Rmd</code></a></small>
      <div class="d-none name"><code>simulating-model.Rmd</code></div>
    </div>

    
    
<p>This vignette walks through using the cowflu package to simulate the
metapopulation model using epidemiological parameters drawn from their
respective posterior distribution, as shown in the previous vignette -
“Model Fitting with cowflu”. This previous vignette ends with the
creation of a <code>fitting_samples</code> list, which will be used in
this vignette. Specific code used is aligned with the associated
publication “A mathematical model of H5N1 influenza transmission in US
dairy cattle”.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrc-ide.github.io/cowflu">cowflu</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/dust2" class="external-link">dust2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrc-ide.github.io/monty" class="external-link">monty</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="load-the-fitted-parameters">Load the fitted parameters<a class="anchor" aria-label="anchor" href="#load-the-fitted-parameters"></a>
</h2>
<p>We load a set of posterior fits from the previous vignette.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Path to the .rds file</span></span>
<span><span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"example_posterior_fits.rds"</span>, package <span class="op">=</span> <span class="st">"cowflu"</span><span class="op">)</span></span>
<span><span class="co"># Load the .rds file</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="extract-posteriors">Extract posteriors<a class="anchor" aria-label="anchor" href="#extract-posteriors"></a>
</h2>
<p>We extract the posterior distributions and collapse the chains
together for easier access:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Collapse chains together:</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">$</span><span class="va">pars</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulate-the-model">Simulate the model<a class="anchor" aria-label="anchor" href="#simulate-the-model"></a>
</h2>
<p>First, decide how many iterations we want to run. For the paper, we
ran 20,000. We do 100 here.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_samples</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="co">## Pluck this number of values from the posterior distributions, selected randomly.</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sim_samples</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">## Pre-allocate array to hold the simulation results:</span></span>
<span><span class="va">Sim_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">144</span>, <span class="fl">51</span><span class="op">)</span><span class="op">)</span> <span class="co">#144 is number of model states, and 51 is number of time points</span></span></code></pre></div>
<p>Finally, run the simulations:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">## Sample the model:</span></span>
<span>  <span class="co">## Set up parameters</span></span>
<span>  <span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="fu">cowflu_inputs</span><span class="op">(</span>alpha <span class="op">=</span> <span class="va">samples</span><span class="op">[</span><span class="fl">1</span>,<span class="va">i</span><span class="op">]</span>, beta <span class="op">=</span> <span class="va">samples</span><span class="op">[</span><span class="fl">2</span>,<span class="va">i</span><span class="op">]</span>, </span>
<span>                                 gamma <span class="op">=</span> <span class="va">samples</span><span class="op">[</span><span class="fl">3</span>,<span class="va">i</span><span class="op">]</span>, sigma <span class="op">=</span> <span class="va">samples</span><span class="op">[</span><span class="fl">4</span>,<span class="va">i</span><span class="op">]</span>,</span>
<span>                                 asc_rate <span class="op">=</span> <span class="va">samples</span><span class="op">[</span><span class="fl">5</span>,<span class="va">i</span><span class="op">]</span>, dispersion <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                 <span class="fu">cowflu</span><span class="fu">:::</span><span class="fu">cowflu_fixed_inputs</span><span class="op">(</span>p_region_export <span class="op">=</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="va">movement</span><span class="op">$</span><span class="va">p_region_export</span>, </span>
<span>                                                              p_cow_export <span class="op">=</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="va">movement</span><span class="op">$</span><span class="va">p_cow_export</span>,</span>
<span>                                                              movement_matrix <span class="op">=</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="va">movement</span><span class="op">$</span><span class="va">movement_matrix</span>,</span>
<span>                                                              time_test <span class="op">=</span> <span class="fl">19</span>,</span>
<span>                                                              n_herds_per_region <span class="op">=</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="va">usda_data</span><span class="op">$</span><span class="va">n_herds_per_region</span>,</span>
<span>                                                              n_cows_per_herd <span class="op">=</span> <span class="fu">cowflu</span><span class="fu">:::</span><span class="va">usda_data</span><span class="op">$</span><span class="va">n_cows_per_herd</span>,</span>
<span>                                                              start_herd <span class="op">=</span> <span class="fl">26940</span>,</span>
<span>                                                              start_count <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                                                              condition_on_export <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                                              <span class="co"># We add custom seeding of the confirmed outbreaks from Caserta et al. (2024)</span></span>
<span>                                                              n_seed <span class="op">=</span> <span class="fl">9L</span>,</span>
<span>                                                              seed_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">11L</span>,<span class="fl">7L</span>,<span class="fl">13L</span>,<span class="fl">12L</span>,<span class="fl">11L</span>,<span class="fl">11L</span>,<span class="fl">12L</span>,<span class="fl">12L</span>,<span class="fl">13L</span><span class="op">)</span><span class="op">-</span><span class="fl">1L</span>,</span>
<span>                                                              seed_herd <span class="op">=</span>   <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">27058L</span>, <span class="fl">27059L</span>, <span class="fl">19577L</span>, <span class="fl">15322L</span>, <span class="fl">27060L</span>, <span class="fl">27061L</span>, <span class="fl">27062L</span>, <span class="fl">15323L</span>, <span class="fl">6850L</span><span class="op">)</span>,</span>
<span>                                                              seed_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">800L</span>,   <span class="fl">1200L</span>,  <span class="fl">787L</span>,   <span class="fl">420L</span>,   <span class="fl">1400L</span>,  <span class="fl">800L</span>,   <span class="fl">528L</span>,   <span class="fl">200L</span>,   <span class="fl">1000L</span><span class="op">)</span></span>
<span>                                 <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Create a dust2 system</span></span>
<span>  <span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu">dust2</span><span class="fu">::</span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_create.html" class="external-link">dust_system_create</a></span><span class="op">(</span><span class="fu">cowflu</span><span class="fu">:::</span><span class="fu">cows</span><span class="op">(</span><span class="op">)</span>, <span class="va">pars</span>, n_particles <span class="op">=</span> <span class="fl">1</span>, dt <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">dust2</span><span class="fu">::</span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_set_state_initial.html" class="external-link">dust_system_set_state_initial</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## We note the model indices that we want to extract. This tells it to skip the herd level information, and only extract the state totals</span></span>
<span>  <span class="va">starting_index</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">*</span><span class="op">(</span><span class="va">pars</span><span class="op">$</span><span class="va">n_herds</span> <span class="op">+</span> <span class="va">pars</span><span class="op">$</span><span class="va">n_regions</span><span class="op">)</span> <span class="op">+</span> <span class="va">pars</span><span class="op">$</span><span class="va">n_herds</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq.int</a></span><span class="op">(</span><span class="va">starting_index</span> <span class="op">+</span> <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">3</span><span class="op">*</span><span class="op">(</span><span class="va">pars</span><span class="op">$</span><span class="va">n_regions</span><span class="op">)</span><span class="op">)</span> <span class="co">#length 144</span></span>
<span>  </span>
<span>  <span class="co">## We also want to extract the number of infections per herd (I_herd) for use with under-reporting calculations.</span></span>
<span>  <span class="va">I_herd_starting_index</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="va">pars</span><span class="op">$</span><span class="va">n_herds</span> <span class="op">+</span> <span class="va">pars</span><span class="op">$</span><span class="va">n_regions</span><span class="op">)</span></span>
<span>  <span class="va">I_herd_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq.int</a></span><span class="op">(</span><span class="va">I_herd_starting_index</span> <span class="op">+</span> <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">n_herds</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Stick the indices of the model outputs we're interested in together</span></span>
<span>  <span class="va">total_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">index</span>, <span class="va">I_herd_index</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Run the simulation</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">dust2</span><span class="fu">::</span><span class="fu"><a href="https://mrc-ide.github.io/dust2/reference/dust_system_simulate.html" class="external-link">dust_system_simulate</a></span><span class="op">(</span><span class="va">sys</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">50</span>, <span class="va">total_index</span><span class="op">)</span> <span class="co">#0:50 is timepoints</span></span>
<span>  </span>
<span>  <span class="co">##Fill the vectors:</span></span>
<span>  <span class="va">Sim_results</span><span class="op">[</span><span class="va">i</span>,,<span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">s</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The output of this is a <code>Sim_results</code> file. A 100 x 144 x
51 array. The first dimension is the simulation number, the second
dimension is the model variable, and the third dimension is the
timepoint. This file will be used in the final vignette, “Plotting model
outputs”.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thomas Rawson, Rich FitzJohn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
